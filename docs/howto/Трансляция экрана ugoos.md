## Трансляция экрана Ugoos в Home Assistant

**Контекст:** HA у тебя — HAOS в виртуалке Proxmox, в одной локальной сети с Ugoos. Подробнее про окружение — в [Окружение.md](../setup/Окружение.md).

### Задача
Сделать на дашборде Home Assistant **живое превью экрана приставки Ugoos X4Q**, не используя скриншоты через ADB (которые вызывают подвисания видео).

### Общая идея
- На Ugoos запускается приложение (например **Screen Stream over HTTP**), которое стримит экран по **MJPEG** (`http://IP:8080/stream.mjpeg`).
- В Home Assistant поток можно подключать двумя путями:
  - **Generic Camera** — встроенная интеграция; с этим приложением даёт таймауты и «Stream never started», подходит только iframe (и то только в локальной сети).
  - **WebRTC + go2rtc** (рекомендуется) — кастомный компонент и go2rtc принимают MJPEG, отдают поток через HA; карточка работает и **извне** (мобильное приложение, Nabu Casa).

---

### Вариант: WebRTC + go2rtc (просмотр и из дома, и не из дома)

Связка **WebRTC** (AlexxIT) и **go2rtc** умеет брать MJPEG по HTTP и показывать его в карточке. Поток идёт через сервер HA, поэтому просмотр работает и с телефона не из дома (Nabu Casa, мобильное приложение).

**Шаг 1. Установить аддон go2rtc (чтобы не было "Can't connect")**

На HAOS встроенный go2rtc из компонента WebRTC часто не поднимается — сразу ставим аддон:

- **Настройки → Дополнения → Репозитории** → добавить `https://github.com/AlexxIT/hassio-addons` → Закрыть.
- **Дополнения** → «+» (добавить дополнение) → найти **go2rtc** (AlexxIT) → Установить → Запустить.

**Шаг 2. Конфиг потоков go2rtc**

Приложение Screen Stream отдаёт **HTML** запросам без браузерного User-Agent (поэтому probe в go2rtc даёт «magic: unsupported header: 3c21444f» — это начало `<!DOCTYPE`). Нужен источник через **ffmpeg** с копированием видео, тогда поток поднимается.

В конфиге go2rtc (файл, который читает аддон, или через веб-интерфейс go2rtc) указать:

```yaml
streams:
  ugoos_tv: ffmpeg:http://192.168.1.62:8080/stream.mjpeg#video=copy
```

Подставь свой IP приставки. Если не заведётся, попробовать с User-Agent:  
`ffmpeg:-user_agent "Mozilla/5.0" -i http://192.168.1.62:8080/stream.mjpeg -c copy -f mpegts pipe:1`

После сохранения — перезапустить дополнение go2rtc (остановить → запустить).  
**Почему не Generic Camera:** в ней нельзя задать User-Agent или ffmpeg — только URL; приставка на такой запрос отдаёт HTML, поэтому стандартная интеграция камеры с этим приложением не работает.

**Превью в go2rtc:** если в интерфейсе go2rtc включаешь превью (thumbnail/снимок) для потока и получаешь ошибку — для MJPEG с Screen Stream это ожидаемо: превью пытается взять один кадр, а источник отдаёт бесконечный поток, без отдельного URL снимка. Превью можно **отключить** — на воспроизведение потока в карточке WebRTC это не влияет.

**Шаг 3. Установить компонент WebRTC и указать go2rtc**

- **HACS** → Интеграции → «+» → **WebRTC** (AlexxIT) → Установить → перезагрузить HA.
- **Настройки → Устройства и службы → Добавить интеграцию** → WebRTC.
- В поле **«Select go2rtc streaming server version»** указать: **`http://localhost:1984`** (именно так, когда go2rtc стоит аддоном).
- Сохранить. Если позже появится «Can't connect to go2rtc server» — зайти в эту интеграцию (WebRTC) → Настроить и проверить, что адрес `http://localhost:1984`.

**Шаг 4. Карточка на дашборде**

В режиме кода карточки (или в YAML дашборда) добавить:

```yaml
type: custom:webrtc-camera
url: ugoos_tv
title: Ugoos TV
```

Вместо `url: ugoos_tv` можно указать прямой URL: `url: 'http://192.168.1.62:8080/stream.mjpeg'` — go2rtc подхватит и его.

**Шаг 5. Режим UI (Lovelace в YAML)**

Если дашборд управляется через YAML, в `configuration.yaml` в секцию **lovelace** добавить ресурс (один раз):

```yaml
lovelace:
  mode: yaml
  resources:
    - url: /webrtc/webrtc-camera.js
      type: module
```

После этого карточка будет показывать поток Ugoos; при открытии дашборда с телефона не из дома поток идёт через HA (go2rtc на стороне HA стягивает MJPEG с приставки и отдаёт в карточку).

*(Раньше в шагах было «оставить поле пустым» для встроенного go2rtc — на HAOS это часто даёт «Can't connect», поэтому в инструкции выше сразу используется аддон и адрес `http://localhost:1984`.)*

---

### Готовые решения в HA: карточка ТВ = экран ТВ

**Встроенная интеграция Android Debug Bridge (ADB)**  
В HA есть опция **«Use screen capture for album art»** (Настройки → Устройства и службы → Android Debug Bridge → Настроить): включи — и обложка/превью медиаплеера будет браться **со снимка экрана** приставки через ADB. Карточка с `entity: media_player.android_tv_...` тогда может показывать этот снимок как картинку. Минус: при видео ADB screencap может давать подвисания (ты с этим уже сталкивался).

---

### Альтернативы при сильной нагрузке на приставку

Если постоянный MJPEG через Screen Stream роняет приставку даже на 1 FPS и 25% качества, варианты:

- **Только по требованию** — включать трансляцию в приложении только когда нужно глянуть экран в HA, потом выключать.
- **GADS-Android-stream** — при просмотре видео картинка меняется каждый кадр, поэтому «только при изменении» не снижает нагрузку; для такого сценария легче Screen Stream не будет.
- **Снимок по запросу (одно подключение = один кадр):**  
  **screenshotserver** (https://github.com/lcacheux/screenshotserver) — на устройстве поднимается сервер (запуск через `adb`), слушает порт (по умолчанию 57000). Клиент подключается → получает **один PNG снимок экрана** → соединение закрывается. То есть не поток, а один кадр на запрос. Минусы: запуск через adb, сервер слушает только localhost — для доступа с HA нужен `adb forward` с хоста, у которого есть adb и сеть до приставки. Документация предупреждает про безопасность и использование скрытых API.

- **Периодический снимок через ADB:** раз в N секунд (например 60) выполнять `adb exec-out screencap -p` с машины, где есть adb и доступ к приставке по сети, сохранять в файл и отдавать его в HA (Generic Camera с `still_image_url` на локальный URL или файл). Нагрузка только в момент снимка. Ты писал, что при видео ADB-скриншоты дают подвисания — при редком вызове (раз в 1–2 минуты) это может быть приемлемо; при частом — нет.

- **Отдельный snapshot-URL в приложении** — в Screen Stream в открытых описаниях такого нет. Если попадётся другое приложение с режимом «один кадр по HTTP» — его можно подставить в `still_image_url`.

---

### 1. Настройка приложения на Ugoos

- Установить приложение для стрима экрана по HTTP (например **Screen Stream over HTTP** с 4PDA).
- Запустить приложение на приставке и:
  - выдать разрешение на **захват экрана** (первый запуск);
  - включить трансляцию (**Start** / «Начать»).

#### Режимы трансляции в приложении

В приложении обычно три режима:

| Режим | Для HA подходит? | Комментарий |
|-------|------------------|-------------|
| **Локальный режим MJPEG** | ✅ **Да** | Поток по HTTP в локальной сети. Generic Camera в HA подключается по URL вида `http://IP:порт/...`. Оптимальный вариант. |
| **Режим RTSP** | ✅ Да | Поток по RTSP. В HA в Generic Camera указываешь `stream_source: rtsp://IP:порт/...`. Тоже работает. |
| **Глобальный режим WebRTC** | ❌ Нет | Для просмотра в браузере снаружи сети. В HA как обычную камеру по URL не подставить. |

**Итого:** для HA можно пробовать **Локальный MJPEG** или **RTSP** (см. ниже).

#### Режим RTSP в Screen Stream — не подходит

В этом приложении **Режим RTSP** просит ввести адрес **внешнего** RTSP-сервера (режим клиента: приставка подключается к серверу). Приставка при этом **не раздаёт** свой экран по RTSP, поэтому для «Ugoos → HA» этот режим не использовать. Остаётся только **Локальный MJPEG** + показ через iframe в HA (см. ниже).

#### Другие настройки приложения — на что смотреть

Пройди все разделы настроек Screen Stream и проверь:

- **Отдельный URL для снимка** — если есть опция вроде «Snapshot URL», «Still image», «Single frame» или отдельный путь типа `/snapshot`, `/image`, `/frame` — его можно подставить в `still_image_url`, тогда камера в HA сможет показывать хотя бы обновляемые кадры.
- **Формат выхода** — если есть выбор кодека/формата (H.264, H.265, MJPEG) или «Compatibility mode», попробуй H.264: stream в HA с ним часто дружит лучше.
- **Режим для видеорегистраторов / NVR / IP-камер** — если есть такой пункт, он может включать отдельный снимок или упрощённый поток под камеры.
- **Порт RTSP** — в режиме RTSP запомни порт и полный путь из приложения и используй их в `stream_source`.

Если найдёшь рабочий RTSP URL или URL одного кадра — напиши, подправим конфиг под него.

#### Остальные настройки (для превью в HA)

| Настройка | Значение | Зачем |
|-----------|----------|--------|
| **Разрешение** | 720p (1280×720) или 960×540 | Меньше нагрузка и трафик; 4K для превью не нужен. |
| **FPS (кадры/с)** | 10–15 | Достаточно для превью; выше — лишняя нагрузка на Ugoos и сеть. |
| **Порт** | 8080 (или любой свободный) | По нему потом соберёшь URL. |
| **Качество / битрейт** | Среднее или ниже | Снижает нагрузку. |
| **Ориентация** | По ситуации (обычно альбомная) | Как удобно смотреть на дашборде. |

- Записать **URL потока**, который показывает приложение после старта:
  - для **MJPEG**: `http://IP_ПРИСТАВКИ:8080/` или путь вида `.../video` (IP Ugoos — в настройках Wi‑Fi приставки или в самом приложении);
  - для **RTSP**: `rtsp://IP_ПРИСТАВКИ:порт/...`.
- Подставить этот URL в Generic Camera в HA (см. ниже).

После этого при включённом экране Ugoos и запущенной трансляции по этому URL доступен поток экрана.

---

### 2. Добавление Generic Camera в Home Assistant

#### Если при добавлении через UI выдаёт «Timeout while loading URL»

При добавлении интеграция делает проверочный запрос к URL с коротким таймаутом; поток с Ugoos может отдавать первый кадр не сразу, из‑за этого проверка падает. **Добавь камеру через YAML** — проверка при настройке не выполняется, сущность создаётся сразу.

1. В HA: **Настройки → Система → Редактор конфигурации** (или правь `configuration.yaml` по SSH).
2. В секцию `camera:` (или создай её) добавь:

```yaml
camera:
  - platform: generic
    name: Ugoos TV
    stream_source: "http://192.168.1.162:8080"
    still_image_url: "http://192.168.1.162:8080"
```

3. Сохрани, **Проверить конфигурацию**, затем **Перезагрузить** (или «Перезагрузить все YAML-конфигурации»).
4. После перезагрузки появится сущность `camera.ugoos_tv` — открой её на дашборде. Поток может подхватиться с задержкой; если картинка так и не появится, см. ниже про ограничение таймаута.

#### Добавление через UI (когда без таймаута)

- **Настройки → Устройства и службы → Добавить интеграцию** → Generic Camera.
- **Stream source URL** — `http://192.168.1.162:8080` (или путь из приложения, например `/video`).
- **Still image URL** — тот же URL или пусто.
- **Username** / **Password** — пусто, если авторизация в приложении не включена.

#### Пример полного блока YAML (для копирования)

Реальный поток приложение отдаёт по пути `/stream.mjpeg` (видно в DevTools → Network по запросу с `Content-Type: multipart/x-mixed-replace`). Корень `:8080/` отдаёт HTML-страницу.

```yaml
camera:
  - platform: generic
    name: Ugoos TV
    stream_source: "http://192.168.1.62:8080/stream.mjpeg"
    still_image_url: "http://192.168.1.62:8080/stream.mjpeg"
```

(IP 192.168.1.62 — подставь свой, если другой.)

После перезагрузки/перечтения конфигурации появится сущность `camera.ugoos_tv`.

---

### 3. «Stream never started» — поток не запускается

MJPEG по сути и есть поток картинок (последовательность JPEG в одном HTTP-ответе). Ограничение не в формате, а в том, как HA с ним работает: для снимка ждёт один кадр и закрытое соединение, для live stream заточен под H.264/RTSP/WebRTC, а MJPEG по HTTP обрабатывает плохо.

Ошибка «Error starting stream, see logs for details (Stream never started)» значит, что компонент **stream** в HA не смог подхватить этот MJPEG. Обходные варианты:

**Вариант A: только still_image_url — не подходит**  
URL `.../stream.mjpeg` отдаёт **непрерывный MJPEG-поток**, а не один кадр. HA для «still image» ждёт один JPEG (один ответ — одна картинка). На этом URL HA ругается, что там нет still image. Если в приложении есть отдельный URL для одного снимка (например `/snapshot` или `/image`) — его можно подставить в `still_image_url`; у Screen Stream по умолчанию такого может не быть.

**Вариант B: карточка в режиме снимка, не потока**  
Если оставляешь оба URL, на карточке можно принудительно использовать снимок вместо потока — тогда ошибка «Stream never started» при открытии не мешает. В конфиге карточки добавь `camera_view: auto` или посмотри в UI карточки опцию «Показ» / «View» и выбери вариант вроде «Auto» или «Snapshot».

**Вариант C: обход — браузер грузит поток напрямую**  
Screen Stream при этом показывает «подключено клиентов: 1» — до Ugoos HA достучивается, данные идут. Не работает только цепочка HA (stream component) → фронт. Если дашборд открыт с устройства в **той же сети**, что и Ugoos (ноут/телефон в 192.168.1.x), можно показать поток в обход HA: карточка **iframe** с URL потока. Тогда браузер сам тянет MJPEG с приставки, без участия stream component.

```yaml
type: iframe
url: "http://192.168.1.62:8080/stream.mjpeg"
aspect_ratio: "16:9"
```

Либо отдельная страница приложения: `url: "http://192.168.1.62:8080/"` — откроется интерфейс Screen Stream с плеером.

**Просмотр не из дома (мобильное приложение, браузер с другого места):** iframe грузит URL напрямую в браузере. С телефона не из дома браузер не в сети 192.168.1.x, до приставки не достучаться — карточка будет пустая или с ошибкой. Варианты:
- **VPN домой** (WireGuard, Tailscale, OpenVPN и т.п.) — подключился к домашней сети с телефона → трафик идёт через дом → 192.168.1.62 доступен, iframe будет работать.
- **Прокси/туннель** — поднять дома прокси, который тянет поток с Ugoos и отдаёт по ссылке через Nabu Casa или свой домен; сложнее в настройке.

**Ошибки в логах при Generic Camera + stream.mjpeg**  
В логах могут появляться:
- `Error getting camera image from http://192.168.1.62: ConnectError` — если в URL не указан порт (должно быть `:8080`).
- `Error getting camera image from http://192.168.1.62:8080/stream.mjpeg: TimeoutError` — Generic Camera ждёт один кадр (конец ответа), а сервер отдаёт бесконечный поток, поэтому таймаут ожидаем.

**Чтобы ошибки не сыпались:** если показываешь Ugoos только через **iframe**, убери блок `camera:` с Generic Camera из `configuration.yaml` (или закомментируй) и перезагрузи конфиг. Сущность камеры исчезнет, логи будут чище. Просмотр — только через карточку iframe.

**Логи:** точную причину смотри в HA: **Настройки → Система → Логи** (или Инструменты разработчика → Логи). В момент открытия камеры ищи строки с `stream` или `generic`.

---

### 4. Карточка на дашборде

Пример простой карточки в Lovelace:

```yaml
type: picture-entity
entity: camera.ugoos_tv
name: Ugoos TV
camera_view: auto
```

Без `camera_view: auto` фронт может пытаться открыть live stream и показывать «Stream never started».

Эта карточка даёт превью экрана Ugoos, когда:
- приставка включена / выведена из sleep;
- приложение стрима экрана запущено и не выгружено системой.

---

### 5. Особенности сна приставки

- В режиме настоящего **sleep** Android:
  - гасит экран;
  - может приостанавливать или завершать захват экрана;
  - не отдаёт нормальный поток — превью в HA либо чёрное, либо обрывается.
- После **пробуждения** приставки:
  - если приложение не выгрузилось, поток **обычно возобновляется автоматически**;
  - важно отключить агрессивную экономию энергии для приложения стрима.

При необходимости можно добавить автоматизацию в HA, которая:
- при включении приставки через ADB запускает нужное приложение (ADB-команда `androidtv.adb_command` с `am start ...`),
- чтобы поток гарантированно поднимался после выхода из sleep.
