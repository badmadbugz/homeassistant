# iBeacon: не добавлять устройства мимо проходящих

**Проблема:** встроенная интеграция **iBeacon** (Home Assistant Core) добавляет в реестр **все** iBeacon, которые видят BLE proxy (ESPHome, Shelly и т.д.) — машины соседей, телефоны прохожих, кошельки. Опция **«Enable Newly added entities» = No** не помогает — это баг.

- **Issue:** [home-assistant/core#88111](https://github.com/home-assistant/core/issues/88111) — открыт с 2023 года, не исправлен.
- После месяцев работы накапливаются сотни «ghost devices» с 5 entities у каждого. GUI удалить не всегда позволяет.

---

## Применённое решение (Bermuda)

1. Установлен **Bermuda BLE Trilateration** (HACS). В Bermuda выбрано только устройство **!Маячок Дымка**.
2. Автоматизация «Режим кормушке по наличию кота» переведена на `device_tracker.bermuda_e2c56db5dffb48d2b060d0f5a71096e0_0_0_bermuda_tracker`.
3. Интеграция **iBeacon** отключена — Bermuda полностью заменяет её для трекинга маячка.
4. ESPHome ble-gateway, когда вернётся в строй, будет работать как Bluetooth Proxy и продолжит кормить HA рекламами — Bermuda увидит маячок без дополнительной настройки.

---

## Обходной путь 1: Bermuda BLE (рекомендуется)

[Bermuda](https://github.com/agittins/bermuda) — custom integration для BLE-трилатерации, которая **позволяет выбрать, какие устройства трекать**. Device tracker стабильнее, чем у встроенного iBeacon.

1. Установить через HACS: **Bermuda BLE Trilateration**.
2. **Настройки** → **Устройства и службы** → Bermuda → **Настроить**.
3. Выбрать только свои устройства (например !Маячок Дымка). Остальные не добавляются.

Встроенную iBeacon при желании можно отключить или не добавлять, если используешь только Bermuda.

---

## Обходной путь 2: Удалять вручную

Периодически чистить реестр:

1. **Настройки** → **Устройства и службы** → **Устройства**.
2. Найти ненужные iBeacon → шестерёнка → **Удалить**.
3. Если GUI не даёт удалить — редактировать `.storage/core.device_registry` и `core.entity_registry` при остановленном HA (осторожно, бэкап).

---

## Обходной путь 3: Оставить только свой маячок (через allow list)

Доки iBeacon: [allow_nameless_uuids](https://www.home-assistant.io/integrations/ibeacon/) — список UUID, которые **явно разрешены**. Это не блокирует остальные, но некоторые пользователи сообщают, что добавление своего UUID в options иногда помогает. Не гарантирует, т.к. баг в другом месте.

**Настройки** → **Устройства и службы** → **iBeacon Tracker** → **Настроить** → добавить UUID: `e2c56db5-dffb-48d2-b060-d0f5a71096e0` (для !Маячок Дымка).

---

## Важно

- **Passive BLE Monitor** — другая интеграция (custom). У неё `discovery: False` + whitelist работает. См. [Passive_BLE_whitelist.md](Passive_BLE_whitelist.md).
- **iBeacon** — встроенная интеграция HA. У неё опция «Enable Newly added entities» **не работает** как задумано.

---

## UUID своего маячка

**!Маячок Дымка:** `e2c56db5-dffb-48d2-b060-d0f5a71096e0`

Проверить: **Инструменты разработчика** → **Состояния** → entity маячка → атрибут `uuid`.

---

## Приложение DX-SMART (CP28)

Модель маячка: **DX-CP28** (PDDAXLQUE). Приложение **DX-SMART** на Android для настройки.
