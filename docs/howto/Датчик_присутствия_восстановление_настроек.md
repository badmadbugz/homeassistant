# Датчик присутствия: автоматическое восстановление настроек

У Zigbee датчика присутствия (Коридор, Human Presence Sensor) периодически **слетают настройки** — в частности, `closest_detection_distance` уходит в 0, что вызывает ошибки MQTT и некорректную работу. Автоматизация отслеживает сброс и восстанавливает нужные значения.

---

## Проблема

В логе HA появляются сообщения:

```
Logger: homeassistant.components.mqtt.number
Invalid value for number.koridor_datchik_prisutstviia_closest_detection_distance: 0 (range 0.1 - 7.0)
```

Датчик через Zigbee2MQTT отправляет в MQTT значение 0, которое выходит за допустимый диапазон (0.1–7.0). Сущность переходит в `unknown`, детекция присутствия перестаёт работать корректно.

---

## Устройство

| Параметр | Значение |
|----------|----------|
| Устройство | Коридор, датчик присутствия |
| Модель | Human Presence Sensor (PJ3201A) |
| Производитель | Dongguan Pinjia Technology Co.,LTD. |
| Подключение | Zigbee2MQTT, Z2M ID `0xa4c1380d4ab69413` |

---

## Целевые настройки

Автоматизация восстанавливает следующие значения:

| Параметр | entity_id | Значение |
|----------|-----------|----------|
| Closest detection distance | `number.koridor_datchik_prisutstviia_closest_detection_distance` | 0.1 |
| Largest movement detection distance | `number.koridor_datchik_prisutstviia_largest_movement_detection_distance` | 2 |
| Largest presence detection distance | `number.koridor_datchik_prisutstviia_largest_presence_detection_distance` | 3 |

> **Примечание:** Датчик иногда перезаписывает 2 и 3 на 6 и 4.5. Автоматизация при каждом запуске (сброс closest_detection или раз в 15 мин) возвращает 2 и 3 — более узкая зона детекции.
| Far movement sensitivity | `number.koridor_datchik_prisutstviia_far_movement_sensitivity` | 2 |
| Far presence sensitivity | `number.koridor_datchik_prisutstviia_far_presence_sensitivity` | 2 |
| Near movement sensitivity | `number.koridor_datchik_prisutstviia_near_movement_sensitivity` | 2 |
| Near presence sensitivity | `number.koridor_datchik_prisutstviia_near_presence_sensitivity` | 2 |
| Idle timeout | `number.koridor_datchik_prisutstviia_idle_timeout` | 10 |
| Movement timeout | `number.koridor_datchik_prisutstviia_movement_timeout` | 10 |
| LED indicator | `switch.koridor_datchik_prisutstviia_led_indicator` | ON |
| Restore factory | `switch.koridor_datchik_prisutstviia_restore_factory` | OFF |

---

## Логика автоматизации

### Триггеры

1. **numeric_state** — `closest_detection_distance` &lt; 0.1 (датчик прислал 0 или некорректное значение)
2. **state** — переход в `unknown` (HA отклонил невалидное значение)
3. **time_pattern** — каждые 15 минут (резервная проверка)

### Условия

Срабатывание только если нужна коррекция:

- `closest_detection_distance` &lt; 0.1 **или**
- `closest_detection_distance` в состоянии `unknown`

### Режим

`mode: restart` — при повторном срабатывании во время выполнения предыдущий запуск перезапускается.

---

## Код автоматизации

Добавить в `automations/automations.yaml` или в HA через **Настройки → Автоматизации и сцены → Создать автоматизацию** (код в YAML).

```yaml
- id: vosstanovit_nastroiki_datchika_prisutstviia
  alias: Восстановить настройки датчика присутствия
  description: При сбросе настроек Zigbee датчика (closest_detection_distance=0) восстанавливает нужные значения
  triggers:
  - platform: numeric_state
    entity_id: number.koridor_datchik_prisutstviia_closest_detection_distance
    below: 0.1
  - platform: state
    entity_id: number.koridor_datchik_prisutstviia_closest_detection_distance
    to: unknown
  - platform: time_pattern
    minutes: '/15'
  conditions:
  - condition: or
    conditions:
    - condition: numeric_state
      entity_id: number.koridor_datchik_prisutstviia_closest_detection_distance
      below: 0.1
    - condition: state
      entity_id: number.koridor_datchik_prisutstviia_closest_detection_distance
      state: unknown
  actions:
  - action: number.set_value
    target:
      entity_id: number.koridor_datchik_prisutstviia_closest_detection_distance
    data:
      value: 0.1
  - action: number.set_value
    target:
      entity_id: number.koridor_datchik_prisutstviia_largest_movement_detection_distance
    data:
      value: 2
  - action: number.set_value
    target:
      entity_id: number.koridor_datchik_prisutstviia_largest_presence_detection_distance
    data:
      value: 3
  - action: number.set_value
    target:
      entity_id:
      - number.koridor_datchik_prisutstviia_far_movement_sensitivity
      - number.koridor_datchik_prisutstviia_far_presence_sensitivity
      - number.koridor_datchik_prisutstviia_near_movement_sensitivity
      - number.koridor_datchik_prisutstviia_near_presence_sensitivity
    data:
      value: 2
  - action: number.set_value
    target:
      entity_id:
      - number.koridor_datchik_prisutstviia_idle_timeout
      - number.koridor_datchik_prisutstviia_movement_timeout
    data:
      value: 10
  - action: switch.turn_on
    target:
      entity_id: switch.koridor_datchik_prisutstviia_led_indicator
  - action: switch.turn_off
    target:
      entity_id: switch.koridor_datchik_prisutstviia_restore_factory
  mode: restart
```

---

## Применение в HA

Если автоматизация хранится в проекте (`automations/automations.yaml`):

1. Скопировать файл в HA:  
   `scp ... automations.yaml root@192.168.1.152:/config/automations.yaml`
2. Перезагрузить автоматизации:  
   `ha core reload automations`

Либо вставить код вручную через **Редактор YAML** в настройках автоматизаций.
