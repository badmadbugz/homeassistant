# Кормушка Aqara C1: расчёт остатка по статистике и график по месяцам

Оценка уровня корма **без доп. датчиков**: используем `weight_per_day` и ручной ввод «сколько насыпал». Остаток = засыпка − накопленная выдача. График по месяцам: максимум после засыпки, затем спад.

---

## Сущности кормушки Aqara C1 (уже есть)

Кормушка подключается через Zigbee2MQTT (модель ZNCWWSQ01LM) и создаёт следующие сущности.

### Используемые для расчёта остатка

| entity_id | Назначение |
|-----------|------------|
| `sensor.kormushka_weight_per_day` | **Граммов выдано за текущий день** — единственная сущность кормушки, с которой работает схема остатка. Обнуляется в полночь. |

### Статистика и настройка порций

| entity_id | Назначение |
|-----------|------------|
| `number.kormushka_portion_weight` | Граммов на одну порцию (1–20 g, по умолчанию 7). Определяет, сколько граммов выдаёт кормушка за одну порцию. |
| `number.kormushka_serving_size` | Сколько порций выдать за одно кормление (1–10). |
| `sensor.kormushka_portions_per_day` | Порций выдано за день (счётчик). |

### Управление и режимы

| entity_id | Назначение |
|-----------|------------|
| `select.kormushka_feed` | Ручная выдача корма: выбрать `START` — кормушка выдаст одну порцию. |
| `select.kormushka_mode` | Режим: `schedule` (по расписанию) или `manual` (только вручную). |
| `sensor.kormushka_schedule` | Текущее расписание кормлений (дни, время, размер порции). |
| `sensor.kormushka_feeding_source` | Источник последней выдачи: schedule, manual или remote. |
| `sensor.kormushka_feeding_size` | Размер последней выдачи (в порциях). |

### Прочее

| entity_id | Назначение |
|-----------|------------|
| `binary_sensor.kormushka_error` | Ошибка кормушки (застревание, пустой бункер и т.п.). |
| `switch.kormushka_led_indicator` | Отключить LED ночью (21:00–09:00). |
| `switch.kormushka_child_lock` | Блокировка физических кнопок на кормушке. |
| `update.kormushka` | Обновление прошивки (Zigbee2MQTT OTA). |

Для расчёта остатка по статистике используется только `sensor.kormushka_weight_per_day`. Остальные сущности — для настройки кормушки и учёта порций.

---

## 1. Хелперы (Input Number)

Создать в **Настройки → Устройства и службы → Хелперы → Создать хелпер → Число** (или добавить YAML в `configuration.yaml` в секцию `input_number:`).

| Имя (friendly_name) | entity_id | min | max | Единица | Начальное | Описание |
|---------------------|-----------|---|-----|---------|-----------|----------|
| Кормушка: граммов при засыпке | `input_number.kormushka_refill_grams` | 0 | 5000 | g | 500 | **Общее количество** корма в кормушке после засыпки (остаток + досыпка). Задаётся вручную после каждой засыпки. Формула: остаток = засыпка − выдано. max: 5000 — чтобы учитывать досыпку в уже наполненную кормушку. |
| Кормушка: выдано с последней засыпки | `input_number.kormushka_dispensed_since_refill` | 0 | 10000 | g | 0 | Накопленное количество граммов, выданных кормушкой с момента последней засыпки. Обновляется автоматически: в 00:01 к нему прибавляется вчерашний `weight_per_day`. Обнуляется скриптом «Подсыпал» после дозахватки. |
| Кормушка: сохранённый вес за день | `input_number.kormushka_saved_daily_weight` | 0 | 500 | g | 0 | **Служебный** буфер. В 23:59 в него копируется `sensor.kormushka_weight_per_day`. В 00:01 это значение прибавляется к «выдано с последней засыпки», после чего буфер обнуляется. Не трогать вручную. |
| Кормушка: съедено за месяц | `input_number.kormushka_total_month` | 0 | 100000 | g | 0 | Статистика: граммов выдано за текущий месяц. Обновляется в 00:01. Сбрасывается 1-го числа. |
| Кормушка: съедено за год | `input_number.kormushka_total_year` | 0 | 500000 | g | 0 | Статистика: граммов выдано за текущий год. Обновляется в 00:01. Сбрасывается 1 января. |

> **Важно:** у хелперов entity_id должны содержать только латиницу (например `kormushka_refill_grams`). Кириллица в ключах YAML приводит к ошибке конфигурации.

### Досыпка (когда в кормушке уже есть корм)

Если подсыпаете корм, когда часть ещё осталась (например, осталось 1 кг, досыпали 2 кг):

1. В «Граммов при засыпке» введите **суммарное количество** — остаток + досыпка: 1000 + 2000 = **3000**.
2. Нажмите «Подсыпал».

Не вводите только досыпку (2 кг) — тогда остаток будет считаться неверно. Для больших кормушек задайте `max: 5000` (или больше) в `input_number` для `kormushka_refill_grams`, иначе нельзя будет ввести 3 кг и больше.

---

## 2. Template-сенсор остатка

Добавить в `configuration.yaml` в секцию `template:` (или **Настройки → Устройства и службы → Template → Добавить → Сенсор**):

```yaml
- sensor:
    - name: "Кормушка остаток граммов"
      unique_id: kormushka_remaining_grams
      unit_of_measurement: "g"
      state_class: measurement
      device_class: weight
      state: >
        {% set refill = states('input_number.kormushka_refill_grams') | float(0) %}
        {% set disp = states('input_number.kormushka_dispensed_since_refill') | float(0) %}
        {{ (refill - disp) | round(0) }}
      availability: "{{ states('input_number.kormushka_refill_grams') not in ['unavailable', 'unknown'] }}"
```

После добавления: **Перезагрузка → Шаблоны** (или перезагрузка HA).

entity_id будет: `sensor.kormushka_ostatok_gramm` (или как HA сгенерирует по `name`).

---

## 3. Автоматизации

### 3.1. Ежедневное накопление (перенос «вчера» в выдано)

В **23:59** сохраняем текущий `weight_per_day` в `kormushka_saved_daily_weight`.  
В **00:01** прибавляем сохранённое значение к `kormushka_dispensed_since_refill`, к `kormushka_total_month`, к `kormushka_total_year` и обнуляем сохранённое.  
В **00:02** 1-го числа — сбрасываем `kormushka_total_month`; 1 января — дополнительно сбрасываем `kormushka_total_year`.

Добавить в `automations.yaml` или создать через **Автоматизации → Создать → Редактировать в YAML**:

```yaml
- id: kormushka_save_daily_weight
  alias: "Кормушка: сохранить вес за день"
  description: "В 23:59 копируем weight_per_day в сохранённый хелпер"
  trigger:
    - platform: time
      at: "23:59:00"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_saved_daily_weight
      data:
        value: "{{ states('sensor.kormushka_weight_per_day') | float(0) }}"
  mode: single

- id: kormushka_accumulate_dispensed
  alias: "Кормушка: накопить выдано за день"
  description: "В 00:01 прибавляем сохранённый вес за день к выдано с последней засыпки"
  trigger:
    - platform: time
      at: "00:01:00"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_total_month
      data:
        value: "{{ states('input_number.kormushka_total_month') | float(0) + states('input_number.kormushka_saved_daily_weight') | float(0) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_total_year
      data:
        value: "{{ states('input_number.kormushka_total_year') | float(0) + states('input_number.kormushka_saved_daily_weight') | float(0) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_dispensed_since_refill
      data:
        value: "{{ states('input_number.kormushka_dispensed_since_refill') | float(0) + states('input_number.kormushka_saved_daily_weight') | float(0) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_saved_daily_weight
      data:
        value: 0
  mode: single

- id: kormushka_reset_monthly_year_stats
  alias: "Кормушка: сброс статистики месяц/год"
  description: "1-го числа сбрасываем месяц, 1 января — год"
  trigger:
    - platform: time
      at: "00:02:00"
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_total_month
      data:
        value: 0
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ now().month == 1 }}"
          sequence:
            - service: input_number.set_value
              target:
                entity_id: input_number.kormushka_total_year
              data:
                value: 0
  mode: single
```

### 3.2. Уведомление «пора подсыпать»

Когда остаток ниже порога (например 50 g) — уведомление. Порог можно вынести в хелпер или заменить число в условии.

```yaml
- id: kormushka_low_food_notify
  alias: "Кормушка: пора подсыпать"
  description: "Остаток корма ниже 50 g"
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.kormushka_ostatok_gramm
      below: 50
  condition:
    - condition: template
      value_template: "{{ states('sensor.kormushka_ostatok_gramm') not in ['unavailable', 'unknown'] }}"
  action:
    - service: persistent_notification.create
      data:
        title: "Кормушка"
        message: "Остаток корма меньше 50 г — пора подсыпать."
  mode: single
```

Если entity_id сенсора остатка другой — заменить в `entity_id` и в `value_template`.

---

## 4. Скрипт «Подсыпал»

При нажатии: обнуляем «выдано с последней засыпки» и при желании задаём новое значение «граммов при засыпке».

Добавить в `scripts.yaml` или через **Сценарии → Создать → Редактировать в YAML**:

```yaml
kormushka_podsypal:
  alias: "Кормушка: подсыпал"
  sequence:
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_dispensed_since_refill
      data:
        value: 0
    - service: input_number.set_value
      target:
        entity_id: input_number.kormushka_saved_daily_weight
      data:
        value: 0
    # Опционально: задать новое количество при засыпке (раскомментировать и подставить значение)
    # - service: input_number.set_value
    #   target:
    #     entity_id: input_number.kormushka_refill_grams
    #   data:
    #     value: 500
  mode: single
```

На дашборде можно повесить кнопку: **Вызов сценария** → `script.kormushka_podsypal`.

---

## 5. Карточки на дашборд

### 5.1. Сводка: осталось / съедено / итого

Компактная карточка-сводка (тип `glance`):

```yaml
type: glance
title: Кормушка
entities:
  - entity: sensor.kormushka_ostatok_gramm
    name: Осталось
  - entity: input_number.kormushka_dispensed_since_refill
    name: Съедено
  - entity: input_number.kormushka_refill_grams
    name: Итого
```

Показывает три значения в одну строку: сколько осталось в кормушке, сколько съедено с засыпки, сколько всего было засыпано.

### 5.2. Управление: засыпка, остаток, кнопка «Подсыпал»

Карточка **Сущности** позволяет прямо с дашборда задавать граммов при засыпке, смотреть остаток и вызывать сценарий «Подсыпал»:

```yaml
type: entities
entities:
  - entity: input_number.kormushka_refill_grams
    name: Граммов при засыпке
  - entity: sensor.kormushka_ostatok_gramm
    name: Остаток
  - entity: input_number.kormushka_total_month
    name: Съедено за месяц
  - entity: input_number.kormushka_total_year
    name: Съедено за год
  - entity: script.kormushka_podsypal
    name: Подсыпал
title: Кормушка
```

Через «Граммов при засыпке» задаётся, сколько засыпано при последней дозахватке. Кнопка «Подсыпал» обнуляет выдано с последней засыпки (нажать после того, как подсыпал корм).

### 5.3. График по месяцам (остаток во времени)

Сенсор остатка пишется в историю. График: по оси X — время, по оси Y — остаток (g); максимум после засыпки, затем спад до следующей засыпки.

**Карточка «История» (линия по дням):**

```yaml
type: history-graph
entities:
  - entity: sensor.kormushka_ostatok_gramm
    name: Остаток корма
hours_to_show: 720
title: Кормушка — остаток по дням
```

`hours_to_show: 720` — примерно 30 дней. Для «по месяцам» можно поставить `168` (неделя) или оставить 720 и смотреть месяц.

**Вариант — карточка «Статистика» (min/max/среднее за период):**

```yaml
type: statistic
entity_id: sensor.kormushka_ostatok_gramm
period: month
stat_type: state
title: Кормушка — остаток за месяц
```

Имя сенсора в конфиге (`name`) может дать другой `entity_id` (например с подчёркиваниями). После создания сенсора посмотреть его в **Настройки → Устройства и службы → Сенсоры** и подставить в карточки вместо `sensor.kormushka_ostatok_gramm`.

---

## 6. Порядок внедрения

1. Создать пять хелперов (Input Number).
2. Добавить template-сенсор остатка, перезагрузить шаблоны.
3. Добавить автоматизации (сохранение в 23:59, накопление в 00:01, сброс месяц/год в 00:02 1-го числа) и авто «пора подсыпать».
4. Добавить сценарий «Подсыпал».
5. Задать начальное значение «граммов при засыпке» (например 500) и при необходимости нажать «Подсыпал», если только что засыпал.
6. Добавить на дашборд карточку управления (засыпка, остаток, кнопка «Подсыпал») и карточку графика (раздел 5).

Дальше при каждой засыпке нажимать «Подсыпал»; при желании менять «граммов при засыпке» прямо на карточке. График по месяцам будет строиться по истории сенсора остатка.
